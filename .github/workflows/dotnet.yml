name: nightly-release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    
    - name: Get current date
      id: date
      run: echo "::set-output name=date::$(date +'%Y-%m-%d-%H-%M')"
      
    - name: Test with environment variables
      run: echo $TAG_NAME - $RELEASE_NAME
      env:
        TAG_NAME: nightly-tag-${{ steps.date.outputs.date }}
        RELEASE_NAME: nightly-release-${{ steps.date.outputs.date }}
        
    - name: Create builddate file
      run: |
        mkdir Client/resources
        echo $DEV_ENV_FILE >> ./Client/resources/builddate.txt
        
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.x
        
    - name: Install dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore
#      dotnet publish ./Client/Client.csproj
#        dotnet build --configuration Release --no-restore
#        dotnet publish ./Client/Client.csproj -f netcoreapp3.1 --runtime win-x64 -c Release -o "{{ env.GITHUB_WORKSPACE }}/publish" --self-contained true /p:UseAppHost=true
#       dotnet publish ./Client/Client.csproj -f netcoreapp3.1 --runtime win-x64 --configuration Release -p:PublishSingleFile=true -p:UseAppHost=true -p:PublishDir=./bin/publish/
#    - name: Test
#      run: dotnet test --no-build --verbosity normal

#    - uses: "marvinpinto/action-automatic-releases@latest"
#      with:
#        repo_token: "${{ secrets.GITHUB_TOKEN }}"
#        automatic_release_tag: "${{ env.TAG_NAME }}"
#        prerelease: true
#        title: "${{ env.RELEASE_NAME }}"
#       files: ./bin/publish/*.exe
#        files: "{{ env.GITHUB_WORKSPACE }}/Client/bin/Release/netcoreapp3.1/*.exe"
    - name: Upload
      uses: "marvinpinto/action-automatic-releases@latest"
      with:
        automatic_release_tag: "LATEST"
        repo_token: "${{ secrets.GITHUB_TOKEN }}"
        prerelease: true
        files: |
          "./Client/bin/Release/netcoreapp3.1/*.exe"
          "./Client/bin/Release/netcoreapp3.1/*.dll"
